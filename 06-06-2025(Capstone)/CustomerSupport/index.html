<html>

<body>
    <h2>SignalR Demo</h2>
    <!-- <button onclick="sendMessage()">Send</button> -->
    <div id="msgs">

    </div>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>
    <script>
        let connection;
        async function startConnection() {
            if (connection && connection.state === "Connected") return;
            connection = new signalR.HubConnectionBuilder()
                .withUrl("http://localhost:5124/chathub", {
                    withCredentials: true
                })
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        return Math.min(retryContext.previousRetryCount * 1000, 5000);
                    }
                })
                .build();

            connection.on("ReceiveMessage", (result) => {
                const placeHolder = document.getElementById("msgs");
                const message = document.createElement("p");
                console.log(result);
                if (result.messageType == 1)
                    message.innerHTML = `Message : ${result.imageName}, Chat Id : ${result.chatId}, User Id : ${result.userId}`;
                else
                    message.innerHTML = `Message : ${result.message}, Chat Id : ${result.chatId}, User Id : ${result.userId}`;
                placeHolder.append(message);
            });

            try {
                await connection.start();
                console.log("SignalR connected");

                await connection.invoke("JoinGroup", 1);
            } catch (err) {
                console.error("SignalR connection failed:", err);
            }
        }

        startConnection();

    </script>
</body>

</html>